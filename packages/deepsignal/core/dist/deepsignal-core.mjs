import{Signal as e,signal as t,computed as r}from"@preact/signals-core";const n=new WeakMap,s=new WeakMap,a=new WeakMap,o=new WeakSet,l=new WeakMap,c=/^\$/;let g=!1;const u=e=>{if(!d(e))throw new Error("This object can't be observed.");return s.has(e)||s.set(e,i(e,y)),s.get(e)},f=(e,t)=>{g=!0;const r=e[t];try{g=!1}catch(e){}return r},i=(e,t)=>{const r=new Proxy(e,t);return o.add(r),r},h=()=>{throw new Error("Don't mutate the signals directly.")},p=e=>(o,l,u)=>{var f;if(g)return Reflect.get(o,l,u);let h=e||"$"===l[0]&&"$"!==l;if(!e&&h&&Array.isArray(o)){if("$"===l)return a.has(o)||a.set(o,i(o,w)),a.get(o);h="$length"===l}n.has(u)||n.set(u,new Map);const p=n.get(u),b=h?l.replace(c,""):l;if(p.has(b)||"function"!=typeof(null==(f=Object.getOwnPropertyDescriptor(o,b))?void 0:f.get)){let e=Reflect.get(o,b,u);if(h&&"function"==typeof e)return;if("symbol"==typeof b&&v.has(b))return e;p.has(b)||(d(e)&&(s.has(e)||s.set(e,i(e,y)),e=s.get(e)),p.set(b,t(e)))}else p.set(b,r(()=>Reflect.get(o,b,u)));return h?p.get(b):p.get(b).value},y={get:p(!1),set(r,a,o,l){n.has(l)||n.set(l,new Map);const g=n.get(l);if("$"===a[0]&&"$"!==a){o instanceof e||h();const t=a.replace(c,"");return g.set(t,o),Reflect.set(r,t,o.peek(),l)}{let e=o;d(o)&&(s.has(o)||s.set(o,i(o,y)),e=s.get(o));const n=Reflect.set(r,a,o,l);return g.has(a)?g.get(a).value=e:g.set(a,t(e)),Array.isArray(r)&&g.has("length")&&(g.get("length").value=r.length),n}},defineProperty(e,t,r){"$"===t[0]&&"$"!==t&&h();const a=!(t in e),o=n.get(s.get(e)),c=Reflect.defineProperty(e,t,r);return"value"in r&&o&&o.has(t)&&(o.get(t).value=r.value),a&&l.has(e)&&l.get(e).value++,c},deleteProperty(e,t){"$"===t[0]&&"$"!==t&&h();const r=n.get(s.get(e)),a=Reflect.deleteProperty(e,t);return r&&r.has(t)&&(r.get(t).value=void 0),l.has(e)&&l.get(e).value++,a},ownKeys:e=>(l.has(e)||l.set(e,t(0)),l._=l.get(e).value,Reflect.ownKeys(e))},w={get:p(!0),set:h,deleteProperty:h},v=new Set(Object.getOwnPropertyNames(Symbol).map(e=>Symbol[e]).filter(e=>"symbol"==typeof e)),b=new Set([Object,Array]),d=e=>"object"==typeof e&&null!==e&&(!("function"==typeof e.constructor&&e.constructor.name in globalThis&&globalThis[e.constructor.name]===e.constructor)||b.has(e.constructor))&&!o.has(e);export{u as deepSignal,f as peek};
//# sourceMappingURL=deepsignal-core.mjs.map
