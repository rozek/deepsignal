import"@preact/signals";import{useMemo as e}from"preact/hooks";import{Signal as t,signal as r,computed as s}from"@preact/signals-core";const n=new WeakMap,o=new WeakMap,a=new WeakMap,l=new WeakSet,c=new WeakMap,g=/^\$/;let i=!1;const u=e=>{if(!d(e))throw new Error("This object can't be observed.");return o.has(e)||o.set(e,p(e,w)),o.get(e)},f=(e,t)=>(i=!0,i=!1,e[t]),p=(e,t)=>{const r=new Proxy(e,t);return l.add(r),r},h=()=>{throw new Error("Don't mutate the signals directly.")},y=e=>(t,l,c)=>{var u;if(i)return Reflect.get(t,l,c);let f=e||"$"===l[0]&&"$"!==l;if(!e&&f&&Array.isArray(t)){if("$"===l)return a.has(t)||a.set(t,p(t,v)),a.get(t);f="$length"===l}n.has(c)||n.set(c,new Map);const h=n.get(c),y=f?l.replace(g,""):l;if(h.has(y)||"function"!=typeof(null==(u=Object.getOwnPropertyDescriptor(t,y))?void 0:u.get)){let e=Reflect.get(t,y,c);if(f&&"function"==typeof e)return;if("symbol"==typeof y&&m.has(y))return e;h.has(y)||(d(e)&&(o.has(e)||o.set(e,p(e,w)),e=o.get(e)),h.set(y,r(e)))}else h.set(y,s(()=>Reflect.get(t,y,c)));return f?h.get(y):h.get(y).value},w={get:y(!1),set(e,s,a,l){n.has(l)||n.set(l,new Map);const c=n.get(l);if("$"===s[0]&&"$"!==s){a instanceof t||h();const r=s.replace(g,"");return c.set(r,a),Reflect.set(e,r,a.peek(),l)}{let t=a;d(a)&&(o.has(a)||o.set(a,p(a,w)),t=o.get(a));const n=Reflect.set(e,s,a,l);return c.has(s)?c.get(s).value=t:c.set(s,r(t)),Array.isArray(e)&&c.has("length")&&(c.get("length").value=e.length),n}},defineProperty(e,t,r){"$"===t[0]&&"$"!==t&&h();const s=!(t in e),a=n.get(o.get(e)),l=Reflect.defineProperty(e,t,r);return"value"in r&&a&&a.has(t)&&(a.get(t).value=r.value),s&&c.has(e)&&c.get(e).value++,l},deleteProperty(e,t){"$"===t[0]&&"$"!==t&&h();const r=n.get(o.get(e)),s=Reflect.deleteProperty(e,t);return r&&r.has(t)&&(r.get(t).value=void 0),c.has(e)&&c.get(e).value++,s},ownKeys:e=>(c.has(e)||c.set(e,r(0)),c.get(e).value=c.get(e).value,Reflect.ownKeys(e))},v={get:y(!0),set:h,deleteProperty:h},m=new Set(Object.getOwnPropertyNames(Symbol).map(e=>Symbol[e]).filter(e=>"symbol"==typeof e)),b=new Set([Object,Array]),d=e=>"object"==typeof e&&null!==e&&(!("function"==typeof e.constructor&&e.constructor.name in globalThis&&globalThis[e.constructor.name]===e.constructor)||b.has(e.constructor))&&!l.has(e),$=t=>e(()=>u(t),[]);export{u as deepSignal,f as peek,$ as useDeepSignal};
//# sourceMappingURL=deepsignal.mjs.map
